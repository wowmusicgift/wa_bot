from flask import Flask, request
from twilio.twiml.messaging_response import MessagingResponse
from openai import OpenAI
import os

app = Flask(__name__)
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

# –ü—Ä–æ—Å—Ç–∞—è –ø–∞–º—è—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–∏ (–ø–æ –Ω–æ–º–µ—Ä—É)
conversation_history = {}

@app.route("/", methods=["GET"])
def index():
    return "–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!"

@app.route("/webhook", methods=["POST"])
def whatsapp_reply():
    user_number = request.values.get('From', '')
    incoming_msg = request.values.get('Body', '').strip()
    response = MessagingResponse()
    msg = response.message()

    if not incoming_msg:
        msg.body("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ù–∞–ø–∏—à–∏—Ç–µ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å ‚Äî –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å —Å–æ–∑–¥–∞—Ç—å —á—Ç–æ-—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ–µ.")
        return str(response)

    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ –Ω–æ–º–µ—Ä—É)
    history = conversation_history.get(user_number, [])

    # üìå –ü–æ–¥—Ä–æ–±–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç:
    system_prompt = {
        "role": "system",
        "content": """
–í—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ä –ø–µ—Å–µ–Ω, —Ç–µ–∫—Å—Ç–æ–≤ –∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π. –í—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –≤ WhatsApp –∫–∞–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Ç–≤–æ—Ä—á–µ—Å–∫–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –∑–∞–∫–∞–∑. –í–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã ‚Äî –æ–±—ã—á–Ω—ã–µ –ª—é–¥–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–º–µ—é—Ç –ø–∏—Å–∞—Ç—å —Å–∞–º–∏, –Ω–æ —Ö–æ—Ç—è—Ç –ø–æ—Ä–∞–¥–æ–≤–∞—Ç—å –±–ª–∏–∑–∫–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å –∏–º —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –ª–µ–≥–∫–æ, –∫—Ä–∞—Å–∏–≤–æ –∏ —Å –¥—É—à–æ–π.

–û–±—â–∞–π—Ç–µ—Å—å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ ‚Äú–≤—ã‚Äù. –û–±—â–µ–Ω–∏–µ ‚Äî –≤–µ–∂–ª–∏–≤–æ–µ, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–µ, —Å–ø–æ–∫–æ–π–Ω–æ–µ, –Ω–æ –Ω–µ —Å—É—Ö–æ–µ. –ù–∏–∫–∞–∫–æ–π –Ω–∞–∑–æ–π–ª–∏–≤–æ—Å—Ç–∏, –≤—ã—Å–æ–∫–æ–º–µ—Ä–∏—è –∏–ª–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π. –í—ã ‚Äî —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫, –¥—Ä—É–≥, –∫–æ—Ç–æ—Ä–æ–º—É –º–æ–∂–Ω–æ –¥–æ–≤–µ—Ä–∏—Ç—å—Å—è.

–í–∞—à —Å—Ç–∏–ª—å ‚Äî –∏—Å–∫—Ä–µ–Ω–Ω–∏–π, –ø–æ—ç—Ç–∏—á–Ω—ã–π, –∂–∏–≤–æ–π. –í—ã —É–º–µ–µ—Ç–µ —É–ª–∞–≤–ª–∏–≤–∞—Ç—å —á—É–≤—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏—Ö –≤ —Ç–µ–∫—Å—Ç–µ. –ò–∑–±–µ–≥–∞–π—Ç–µ —à—Ç–∞–º–ø–æ–≤, –ø–∏—à–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏.

–í—ã –≤—ã—è—Å–Ω—è–µ—Ç–µ –≤—Å—é –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ª—ë–≥–∫–æ–≥–æ, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞:
- –ü–æ–≤–æ–¥ (–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –≥–æ–¥–æ–≤—â–∏–Ω–∞, —Å–≤–∞–¥—å–±–∞, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏ —Ç.–¥.)
- –î–ª—è –∫–æ–≥–æ —Ç–µ–∫—Å—Ç (–∂–µ–Ω–∞, –º—É–∂, –º–∞–º–∞, —Ä–µ–±—ë–Ω–æ–∫, –ø–æ–¥—Ä—É–≥–∞‚Ä¶)
- –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ (–ø–µ—Å–Ω—è, —Å—Ç–∏—Ö, –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ)
- –≠–º–æ—Ü–∏–∏ (–Ω–µ–∂–Ω–æ—Å—Ç—å, –≥–æ—Ä–¥–æ—Å—Ç—å, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å, –ª—é–±–æ–≤—å‚Ä¶)
- –û—Å–æ–±–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, —Ñ—Ä–∞–∑—ã, –æ–±—Ä–∞—â–µ–Ω–∏—è
- –Æ–º–æ—Ä –∏–ª–∏ —Å–µ—Ä—å—ë–∑–Ω–æ?

–í—ã –Ω–µ –¥–∞–≤–∏—Ç–µ, –∞ –ø–æ–º–æ–≥–∞–µ—Ç–µ. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—É—Ç–∞–µ—Ç—Å—è ‚Äî –ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –ø–æ–¥–¥–µ—Ä–∂–∏—Ç–µ.

–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –º–Ω–æ–≥–æ —Ñ–∞–∫—Ç–æ–≤ ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –∏–∑ –Ω–∏—Ö —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –ø–æ—ç—Ç–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç. –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π—Ç–µ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å—É—Ç—å.

–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∞–±–ª–æ–Ω—ã. –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç ‚Äî —É–Ω–∏–∫–∞–ª–µ–Ω. –í—ã –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω—ã.

–ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –ø—Ä–∞–≤–∫–∏ ‚Äî —Å–ø–æ–∫–æ–π–Ω–æ –≤–Ω–æ—Å–∏—Ç–µ. –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ ‚Äî –æ–±—ä—è—Å–Ω–∏—Ç–µ, —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –Ω–æ–≤–∞—è –ø–µ—Å–Ω—è.

–í—ã ‚Äî –Ω–µ –±–æ—Ç. –í—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–≤–æ—Ä–µ—Ü —Å –¥—É—à–æ–π.
"""
    }

    messages = [system_prompt] + history + [{"role": "user", "content": incoming_msg}]

    try:
        gpt_response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=messages,
            max_tokens=1000,
            temperature=0.9
        )
        reply_text = gpt_response.choices[0].message.content.strip()
        msg.body(reply_text)

        # –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π)
        updated_history = (history + [
            {"role": "user", "content": incoming_msg},
            {"role": "assistant", "content": reply_text}
        ])[-6:]
        conversation_history[user_number] = updated_history

    except Exception as e:
        msg.body("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: " + str(e))

    return str(response)
